<!DOCTYPE html>
<meta charset="utf-8">

<head>
<!-- <script src="node_modules/d3/dist/d3.min.js"> </script> -->
<script src="https://d3js.org/d3.v6.min.js"></script>


<style>
.auxLines{
  stroke: black;
  fill: none;
  stroke-width: 0.2;
}
.mainLines{
  stroke: black;
  fill: none;
  stroke-width: 2;
}
.controlPoints{
  stroke: black;
  fill: red;
  stroke-width: 2;
}
.marble{
  stroke: blue;
  fill: blue;
  stroke-width: 2;
}
.trace{
  stroke: none;
  fill: #00CED1;
  opacity: 0.3;
  stroke-width: 2;
}
</style>

</head>

<body>
<svg id="svg"> </svg>


<script>

// CURVE DESIGN

svg = d3.select("svg")
          .attr("width", "1000")
          .attr("height", "500");

curvegrp = svg.append("g")
          .attr("transform","translate(250 250)")

curvegrp.append("circle").attr("class","mainLines")
          .attr("cx",0)
          .attr("cy",0)
          .attr("r",200)


//var CP = [[0,0],[100,0],[100,200],[0,200]];
 var CP = [[0,0],[55,0],[100,45],[100,100],[100,155],[55,200],[0,200]];

var lines=[];


pth = curvegrp.append("path")
      .attr("class","mainLines")

pointsSel = curvegrp.selectAll(".controlPoints").data(CP);

pointsSel.enter()
        .append("circle").attr("class","controlPoints")
          .attr("r",6)
          .attr("cx",function(d){return d[0]})
          .attr("cy",function(d){return d[1]});




function pathFromDOMPoints(cps){
  var d = "M ";
  d+= (cps[0].x +' '+ cps[0].y +' ');
  for (i=1; i<cps.length; i++){
    if (i%3 == 1) {d+= "C "}
    d+=(cps[i].x +' '+ cps[i].y +', ')}
  return d;
};


CP1 =[];



//var pathdata;

function makeLines(cps){
  var lines = []
  for (i=0;i<cps.length-1; i++){
    if (i%3!=1) {lines.push([cps[i],cps[i+1]]) }
  }
  return lines
}

// lines = makeLines(CP);
// console.log(lines);
// console.log(linesSel);

function draw (){
  //lines = [ [CP[0],CP[1]] , [CP[2],CP[3]] ];
  lines = makeLines(CP);
  linesSel = curvegrp.selectAll("line").data(lines);
  console.log(linesSel);

  linesSel.enter()
            .append("line").attr("class","auxLines")
          .merge(linesSel)
            .attr("x1",function(d){return d[0][0]})
            .attr("y1",function(d){return d[0][1]})
            .attr("x2",function(d){return d[1][0]})
            .attr("y2",function(d){return d[1][1]});

    CP.forEach((item, i) => { CP1[i] = new DOMPoint(CP[i][0],CP[i][1]) });
    pth.attr("d",pathFromDOMPoints(CP1))

}

//draw();
draw();

var dragHandler = d3.drag()
        .on("drag", function (event,d) {
          d3.select(this)
              .attr("cx", d[0] = event.x)
              .attr("cy", d[1] = event.y);

          draw();
          })

dragHandler(curvegrp.selectAll("circle"));



// ROTATING WHEEL

wheelgrp = svg.append("g")
          .attr("transform","translate(750 250)")

rwheel = wheelgrp.append("g")

wheelgrp.append("circle").attr("class","mainLines")
          .attr("cx",0)
          .attr("cy",0)
          .attr("r",200)


pathOnWheel = svg.append("path")
                    .attr("class","mainLines")
var angle = 0;
var RotAngle = 180;

CP2=[];



marble = svg.append("circle").attr("class","marble").attr("r",4)


IndexOfMaxY = 499;

function turnWheel(){
  angle+=1;
  if(angle >= RotAngle) {clearInterval(timer);}

  rwheel.attr("transform", "rotate("+ angle + ")" );
  //console.log(pathdata);
  rotMatrix = rwheel.node().getCTM();
  CP.forEach((item, i) => { CP2[i] = new DOMPoint(CP[i][0],CP[i][1]).matrixTransform(rotMatrix) });

  pathOnWheel.attr("d",pathFromDOMPoints(CP2))

  var pointsOnCurve =[];
  var path = pathOnWheel.node();
  var length = path.getTotalLength();
  for(i=0; i<500; i++){ pointsOnCurve.push(path.getPointAtLength(i*length/500)) }

  var lowBound = Math.max(IndexOfMaxY-20,0);
  var upBound = Math.min(IndexOfMaxY+20,499);
  pieceOfCurve = pointsOnCurve.slice(lowBound,upBound)
  var localIndex;
  localIndex = pieceOfCurve.reduce(function(accumulator, currentValue, currentIndex, array)
            {return currentValue.y>array[accumulator].y ? currentIndex : accumulator}, 0)
  IndexOfMaxY = lowBound + localIndex;

  P=pointsOnCurve[IndexOfMaxY]

  marble
    .attr("cx",P.x)
    .attr("cy",P.y-4)

  if (d3.select("#trace").property("checked")) {
        svg.append("circle").attr("class","mainLines").attr("class","trace")
            .attr("cx",P.x)
            .attr("cy",P.y-4)
            .attr("r",4)
        }
}


function go(){
  d3.selectAll(".trace").remove();
  angle = 0;
  IndexOfMaxY = 499;

  timer = setInterval(turnWheel,60);
}

</script>



<br>
<button onclick="go()"> Go! </button>
<br>
<input type="checkbox" id="trace"> Trace

</body>

</html>
